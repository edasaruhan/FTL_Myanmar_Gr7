<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Helmet Detection Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
               min-height: 100vh; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; background: white; 
                     border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
                     padding: 30px; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.1em; }
        
        .upload-area { border: 3px dashed #ccc; border-radius: 10px; 
                      padding: 40px; text-align: center; margin: 20px 0; 
                      transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { border-color: #667eea; background: #f9f9ff; }
        .upload-area.dragover { border-color: #667eea; background: #eef2ff; }
        
        .upload-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                     color: white; border: none; padding: 12px 30px; 
                     border-radius: 25px; font-size: 16px; cursor: pointer; 
                     margin-top: 15px; }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .image-display { display: flex; gap: 20px; margin: 30px 0; 
                        flex-wrap: wrap; justify-content: center; }
        .image-box { flex: 1; min-width: 300px; text-align: center; }
        .image-box img { max-width: 100%; border-radius: 8px; 
                        box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
                        border: 1px solid #eee; }
        
        .results { background: #f8f9fa; border-radius: 10px; padding: 20px; 
                  margin-top: 30px; }
        .stats { display: flex; justify-content: center; gap: 30px; 
                margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 8px; 
                   text-align: center; min-width: 120px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .stat-value { font-size: 2em; font-weight: bold; }
        .helmet-stat { color: #10b981; }
        .no-helmet-stat { color: #ef4444; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f1f5f9; }
        .confidence-bar { background: #e5e7eb; height: 10px; border-radius: 5px; }
        .confidence-fill { height: 100%; border-radius: 5px; }
        .high-confidence { background: linear-gradient(90deg, #10b981, #34d399); }
        .med-confidence { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .low-confidence { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; 
                  border-radius: 50%; width: 40px; height: 40px; 
                  animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .image-display { flex-direction: column; }
            .stats { flex-direction: column; align-items: center; }
        }

        .video-container {
    display: flex;
    gap: 20px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.video-box {
    flex: 1;
    min-width: 300px;
    text-align: center;
}

.video-box video {
    max-width: 100%;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border: 1px solid #eee;
    background: #000;
}

.stats-grid {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin: 20px 0;
}

.video-stats, .detection-stats {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}

.message-box {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 15px;
    border-radius: 4px;
    margin: 20px 0;
}

.note {
    color: #666;
    font-style: italic;
    margin-top: 10px;
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš€ Helmet Detection Demo</h1>
            <p class="subtitle">Upload an image to detect helmets with confidence scores and bounding boxes</p>
        </header>
        
        <!-- Upload Area -->
        <div class="upload-area" id="dropArea">
            <h3>ðŸ“¤ Drag & Drop Image or Video Here</h3>  <!-- Updated text -->
            <p>Supported: Images (JPG, PNG, GIF, BMP) & Videos (MP4, AVI, MOV, MKV)</p>  <!-- Updated text -->
            <!-- More specific video formats: -->
<input type="file" id="fileInput" accept="image/*,.mp4,.avi,.mov,.mkv,video/*" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose Image or Video File
            </button>
            <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                Supported formats: JPG, PNG, GIF, BMP, MP4, AVI, MOV, MKV | Max size: 100MB
            </p>
        </div>
        
        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Processing image with YOLOv8 model...</p>
        </div>
        
        <!-- Results Display -->
        <div id="resultsContainer" style="display: none;">
            <div class="image-display">
                <div class="image-box">
                    <h3>ðŸ“· Original Image</h3>
                    <img id="originalImage" src="" alt="Original">
                </div>
                <div class="image-box">
                    <h3>âœ… Processed Result</h3>
                    <img id="resultImage" src="" alt="Result with detections">
                </div>
            </div>
            
            <div class="results">
                <div class="stats" id="statsDisplay"></div>
                
                <h3>ðŸ“Š Detection Details</h3>
                <table id="detectionsTable">
                    <thead>
                        <tr>
                            <th>Class</th>
                            <th>Confidence</th>
                            <th>Bounding Box</th>
                            <th>Visual</th>
                        </tr>
                    </thead>
                    <tbody id="detectionsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // Drag and drop handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'));
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'));
        });
        
        dropArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            // Check for both image and video files
    const isImage = file.type.match('image.*');
    const isVideo = file.type.match('video.*');
    
    if (!isImage && !isVideo) {
        alert('Please upload an image or video file (JPG, PNG, MP4, AVI, MOV, MKV)');
        return;
    }
    
    // Debug log
    console.log("Selected file type:", file.type, "File name:", file.name);
    console.log("Is image?", isImage, "Is video?", isVideo);
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading
            loading.style.display = 'block';
            resultsContainer.style.display = 'none';
            
            // Send to Flask backend
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
    // Check file type and display accordingly
    if (data.file_type === 'image') {
        displayImageResults(data);
    } else if (data.file_type === 'video') {
        displayVideoResults(data);
    }
}).catch(error => {
                loading.style.display = 'none';
                alert('Upload failed: ' + error);
            });
        }
// displayImageResults:

 function displayImageResults(data) {
    const resultsContainer = document.getElementById('resultsContainer');
    
    // Completely rebuild the HTML (simpler approach)
    resultsContainer.innerHTML = `
        <div class="image-display">
            <div class="image-box">
                <h3>ðŸ“· Original Image</h3>
                <img id="originalImage" src="${data.original_image || data.original_file}" alt="Original">
            </div>
            <div class="image-box">
                <h3>âœ… Processed Result</h3>
                <img id="resultImage" src="${data.result_image || data.result_file}" alt="Result with detections">
            </div>
        </div>
        
        <div class="results">
            <div class="stats" id="statsDisplay">
                <div class="stat-box">
                    <div class="stat-value helmet-stat">${data.stats.helmet}</div>
                    <div>Safe</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value no-helmet-stat">${data.stats.no_helmet}</div>
                    <div>Rule Violation</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.stats.total}</div>
                    <div>Total Detections</div>
                </div>
            </div>
            
            <h3>ðŸ“Š Detection Details</h3>
            <table id="detectionsTable">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Confidence</th>
                        <th>Bounding Box</th>
                        <th>Visual</th>
                    </tr>
                </thead>
                <tbody id="detectionsBody">
                    ${data.detections.map(det => {
                        const confidenceClass = det.confidence > 80 ? 'high-confidence' : 
                                               det.confidence > 50 ? 'med-confidence' : 'low-confidence';
                        return `
                        <tr>
                            <td><strong>${det.class === 'Helmet' ? 'Safe' : 'Rule Violation'}</strong></td>
                            <td>
                                ${det.confidence.toFixed(2)}%
                                <div class="confidence-bar">
                                    <div class="confidence-fill ${confidenceClass}" 
                                         style="width: ${det.confidence}%"></div>
                                </div>
                            </td>
                            <td>[${det.bbox.map(x => x.toFixed(1)).join(', ')}]</td>
                            <td>
                                <span style="display: inline-block; width: 15px; height: 15px; 
                                      background: ${det.class === 'Helmet' ? '#10b981' : '#ef4444'}; 
                                      border-radius: 3px;"></span>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    resultsContainer.style.display = 'block';
    resultsContainer.scrollIntoView({ behavior: 'smooth' });
}
// Add this function after displayImageResults:
function displayVideoResults(data) {
    const resultsContainer = document.getElementById('resultsContainer');
    
    let videoHTML = `
        <h2>ðŸŽ¥ Video Detection Results</h2>
        <div class="video-container">
            <div class="video-box">
                <h3>ðŸ“¹ Original Video</h3>
                <video controls width="100%" src="${data.original_file}?t=${Date.now()}">
                </video>
                <p><small>Uploaded video: ${data.original_file.split('/').pop()}</small></p>
            </div>
            <div class="video-box">
                <h3>âœ… Processed Video (with detections)</h3>
                <video controls width="100%" src="${data.result_file}?t=${Date.now()}">
                </video>
                <p><small>Processed video with helmet detections</small></p>
            </div>
        </div>
        
        <div class="video-stats">
            <h3>ðŸ“Š Video Information</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value">${data.video_info.total_frames}</div>
                    <div>Total Frames</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.video_info.fps}</div>
                    <div>FPS</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.video_info.duration_seconds}s</div>
                    <div>Duration</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.stats.total}</div>
                    <div>Sample Detections</div>
                </div>
            </div>
        </div>
        
        <div class="detection-stats">
            <h3>ðŸ‘· Detection Statistics (Sample Frames)</h3>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value helmet-stat">${data.stats.helmet}</div>
                    <div>Safe</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value no-helmet-stat">${data.stats.no_helmet}</div>
                    <div>Rule Violation</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${data.stats.total}</div>
                    <div>Total Detections</div>
                </div>
            </div>
            <p class="note"><small>Note: Statistics based on first 10 frames for performance</small></p>
        </div>
        
        <div class="message-box">
            <p>${data.message}</p>
            <p>Video saved to: <code>${data.result_file}</code></p>
        </div>
    `;
    
    resultsContainer.innerHTML = videoHTML;
    resultsContainer.style.display = 'block';
    resultsContainer.scrollIntoView({ behavior: 'smooth' });
}
console.log("Selected file type:", file.type, "File name:", file.name);
    </script>
</body>
</html>